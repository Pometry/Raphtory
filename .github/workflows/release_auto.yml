name: ðŸš€ðŸ¦€ðŸðŸ³ðŸ™ Publish all packages to crates.io, PyPi, Docker Hub & Github

env:
  PYTHON_VERSION: 3.14.2
  DEBIAN_VERSION: trixie

on:
  workflow_dispatch:
    inputs:
      base:
        description: Branch/tag/commit to publish from
        type: string
        default: master
      dry_run:
        description: If selected will not publish to crates.io/Pypi/Docker Hub but will release to github
        type: boolean
        default: false

jobs:
  read-raphtory-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.base }}
      - id: version
        run: echo "version=$(make print-version)" >> $GITHUB_OUTPUT
  call-release-rust-workflow:
    name: _Release 2 - Publish Rust package to crates.io
    uses: ./.github/workflows/_release_rust.yml
    with:
      base: ${{ inputs.base }}
      dry_run: ${{ inputs.dry_run == true }}
    secrets: inherit
  call-release-python-workflow:
    name: _Release 3 - Publish python to pypi
    uses: ./.github/workflows/_release_python.yml
    with:
      base: ${{ inputs.base }}
      dry_run: ${{ inputs.dry_run == true }}
    secrets: inherit
  call-release-github-workflow:
    name: _Release 4 - Publish to Github
    uses: ./.github/workflows/_release_github.yml
    with:
      base: ${{ inputs.base }}
    secrets: inherit
  call-release-docker-workflow-rust:
    name: Release rust docker image
    needs: read-raphtory-version
    uses: ./.github/workflows/_release_docker.yml
    with:
      base: ${{ inputs.base }}
      dry_run: ${{ inputs.dry_run == true }}
      tag: |
        ${{ needs.read-raphtory-version.outputs.version }}
        latest
    secrets: inherit
  call-release-docker-workflow-python:
    name: Release python docker image
    needs: read-raphtory-version
    uses: ./.github/workflows/_release_docker.yml
    with:
      base: ${{ inputs.base }}
      dry_run: ${{ inputs.dry_run == true }}
      tag: |
        ${{ needs.read-raphtory-version.outputs.version }}-python${{ env.PYTHON_VERSION }}-${{ env.DEBIAN_VERSION }}
        ${{ needs.read-raphtory-version.outputs.version }}-python
        latest-python
      python: ${{ env.PYTHON_VERSION }}-slim-${{ env.DEBIAN_VERSION }}
    secrets: inherit
